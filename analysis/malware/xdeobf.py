import sys
from collections import OrderedDict

def parse_args(INFO):

	MENU = { \

			"OBF":"Obfuscated algorithm file", \
			"OF":"Output file (Not implemented)"

		}

	for i in range(1,len(sys.argv)):
		CURR = sys.argv[i]

		if CURR[:2] == "--":
			if CURR[2:] == "help":
				print_dict(MENU)
				sys.exit()

		KEY = CURR.split("=")[0]

		if KEY in INFO.keys():
			INFO[KEY] = CURR[(len(KEY)+1):]

	return INFO

def parse_obfs(OBFS,IFILE):
	for i in IFILE:
		SFILE = i.split(":")[0]
		LO = i[(len(SFILE)+1):]
		FUNC = LO.replace(" ","").split("=")[0]
		PCS = LO.replace(" ","").replace("\n","").split("=")[1].split("+")
		OBFS[FUNC] = { \
					"SFILE":SFILE, \
					"PCS":OrderedDict(), \
					"ALG": OrderedDict(), \
					"FULLSTR":""
				}

		for z in LO.replace(" ","").replace("\n","").split("=")[1].split("+"):
			OBFS[FUNC]["PCS"][z] = z

	return OBFS

def begin_deobf(OBFS,FILE):
	for KEY in OBFS.keys():

		curr_file = open(OBFS[KEY]["SFILE"],"r")

		FILE[OBFS[KEY]["SFILE"]] = ""

		for LINE in curr_file:

			FILE[OBFS[KEY]["SFILE"]] += LINE

			BEGIN = LINE.replace(" ","").split("=")[0]

			if BEGIN in OBFS[KEY]["PCS"].keys():

				OSTR = LINE.replace(" ","").replace("\n","").replace(")","").split("(")[1].split(",")[0]
				ENTRY = int(LINE.replace(" ","").replace("\n","").replace(")","").split("(")[1].split(",")[1])
				LEN = int(LINE.replace(" ","").replace("\n","").replace(")","").split("(")[1].split(",")[2])

				OBFS[KEY]["ALG"][BEGIN] = { \
								"OSTR":OSTR, \
								"ENTRY":ENTRY, \
								"LEN":LEN, \
								"STR":""
								}

	return OBFS,FILE

def construct_deobf(OBFS,FILE):
	for KEY in OBFS.keys():

		for PC1 in OBFS[KEY]["ALG"].keys():

			PC2 = OBFS[KEY]["ALG"][PC1]["OSTR"]

			for CHUNK in FILE[OBFS[KEY]["SFILE"]].split("\n"):

				if PC2 in CHUNK.replace(" ","").split("=")[0]:

					ENTRY = OBFS[KEY]["ALG"][PC1]["ENTRY"]
					LEN = OBFS[KEY]["ALG"][PC1]["LEN"]

					FOUND_STR = CHUNK.replace('"','').split("=")[1][ENTRY:(ENTRY+LEN)]
					OBFS[KEY]["ALG"][PC1]["STR"] = FOUND_STR

	return OBFS

def print_results(OBFS):
	for KEY in OBFS.keys():

		print("      Obfuscated Variable:     "+KEY)
		print("              Source File:     "+OBFS[KEY]["SFILE"])
		print("     De-obfuscated String\n------------------------------------------------")

		for PC in OBFS[KEY]["PCS"].keys():

			if PC in OBFS.keys() or PC[:4] == "Chr(":
				OBFS[KEY]["FULLSTR"] += "<<"+PC+">>    "
				continue
			OBFS[KEY]["FULLSTR"] += OBFS[KEY]["ALG"][PC]["STR"]

		print(OBFS[KEY]["FULLSTR"])
		print("\n\n")

def print_dict(INFO):
	for i in INFO.keys():
		print("  "+i+" "*(10-len(i))+"		"+str(INFO[i]))


def main():

	files = {}

	cliArgs = { \

			"IF":"", \
			"OF":""

		 }

	cliArgs = parse_args(cliArgs)

	if cliArgs["IF"]:
		obfFile = open(cliArgs["IF"], "r")

	if cliArgs["OF"]:
		outFile = open(cliArgs["OF"], "w")

	obfStrs = OrderedDict()

	obfStrs = parse_obfs(obfStrs,obfFile)

	obfStrs,files = begin_deobf(obfStrs,files)

	obfStrs = construct_deobf(obfStrs,files)

	print_results(obfStrs)

if __name__ == "__main__":
	main()
